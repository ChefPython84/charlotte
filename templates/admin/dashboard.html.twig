{# templates/admin/dashboard.html.twig #}
{% extends '@EasyAdmin/page/content.html.twig' %}

{% block title %}Administration ‚Äî Tableau de bord{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1">Tableau de bord</h1>
      <p class="text-muted mb-0">R√©sum√© et acc√®s rapide au back-office.</p>
    </div>

    <div class="d-flex gap-2">
      {# MODIFI√â : Utilise ea_url() pour pointer vers le CRUD EasyAdmin #}
      <a href="{{ ea_url().setController('App\\Controller\\Admin\\UserCrudController').setAction('new') }}" class="btn btn-sm btn-primary">‚ûï Nouvel utilisateur</a>
      <a href="{{ ea_url().setController('App\\Controller\\Admin\\SalleCrudController') }}" class="btn btn-sm btn-outline-primary">Salles</a>
    </div>
  </div>

  <div class="row g-3 mb-4">
 
    <div class="col-6 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="me-3">
              <svg width="36" height="36" viewBox="0 0 24 24"><rect width="24" height="24" rx="4" fill="#e9f5ff"/><path d="M4 7h16M4 11h16M4 15h16" stroke="#0d6efd" stroke-width="1.2" stroke-linecap="round"/></svg>
            </div>
         
            <div>
              <div class="text-muted small">Salles</div>
              <div class="h5 mb-0">{{ totalSalles|default(0) }}</div>
            </div>
          </div>
        </div>
        <div class="card-footer bg-transparent border-top-0">
          {# MODIFI√â : Utilise ea_url() #}
          <a href="{{ ea_url().setController('App\\Controller\\Admin\\SalleCrudController') }}" class="small">G√©rer les salles ‚Üí</a>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="me-3">
              <svg width="36" height="36" viewBox="0 0 24 24"><rect width="24" height="24" rx="4" fill="#eef9ec"/><path d="M12 14c3 0 5 1.5 5 3v1H7v-1c0-1.5 2-3 5-3zM12 7a3 3 0 100 6 3 3 0 000-6z" fill="#198754"/></svg>
            </div>
            <div>
              <div class="text-muted small">Utilisateurs</div>
              <div class="h5 mb-0">{{ totalUsers|default(0) }}</div>
            </div>
          </div>
        </div>
         <div class="card-footer bg-transparent border-top-0">
          {# MODIFI√â : Utilise ea_url() #}
          <a href="{{ ea_url().setController('App\\Controller\\Admin\\UserCrudController') }}" class="small">G√©rer les utilisateurs ‚Üí</a>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="me-3">
               <svg width="36" height="36" viewBox="0 0 24 24"><rect width="24" height="24" rx="4" fill="#fff4e6"/><path d="M6 7h12v10H6z" stroke="#fd7e14" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <div>
              <div class="text-muted small">R√©servations</div>
              <div class="h5 mb-0">{{ totalReservations|default(0) }}</div>
            </div>
          </div>
  
        </div>
        <div class="card-footer bg-transparent border-top-0">
          {# MODIFI√â : Utilise ea_url() #}
          <a href="{{ ea_url().setController('App\\Controller\\Admin\\ReservationCrudController') }}" class="small">Voir le planning ‚Üí</a>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
             <div class="me-3">
              <svg width="36" height="36" viewBox="0 0 24 24"><rect width="24" height="24" rx="4" fill="#eef2ff"/><path d="M7 10h10M7 14h7" stroke="#6366f1" stroke-width="1.5" stroke-linecap="round"/></svg>
            </div>
            <div>
              <div class="text-muted small">Factures</div>
              <div class="h5 mb-0">{{ totalFactures|default(0) }}</div>
             </div>
          </div>
        </div>
        <div class="card-footer bg-transparent border-top-0">
          {# MODIFI√â : Utilise ea_url() #}
          <a href="{{ ea_url().setController('App\\Controller\\Admin\\FactureCrudController') }}" class="small">G√©rer les factures ‚Üí</a>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-7">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
           <strong>R√©servations r√©centes</strong>
           {# MODIFI√â : Utilise ea_url() #}
          <a href="{{ ea_url().setController('App\\Controller\\Admin\\ReservationCrudController') }}" class="small">Voir tout</a>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                   <th>Client</th>
                  <th>Salle</th>
                  <th>Date d√©but</th>
                  <th>Date fin</th>
                  <th>Status</th>
                 </tr>
              </thead>
              <tbody>
                {% if recentReservations|length == 0 %}
                  <tr>
                    <td colspan="5" class="text-center py-4 text-muted">Aucune r√©servation r√©cente.</td>
                   </tr>
                {% else %}
                  {% for r in recentReservations %}
                    <tr>
                      <td>{{ r.user ? r.user : 'Invit√©' }}</td>
                      <td>{{ r.salle ? r.salle.nom : '-' }}</td>
                      <td>{{ r.dateDebut ? r.dateDebut|date('Y-m-d H:i') : '-' }}</td>
                      <td>{{ r.dateFin ? r.dateFin|date('Y-m-d H:i') : '-' }}</td>
                      <td>
                        {% set s = r.statut|default('en attente') %}
                        <span class="badge 
                           {% if s == 'confirm√©e' or s == 'confirme' %} bg-success
                          {% elseif s == 'annul√©e' or s == 'annule' %} bg-danger
                          {% elseif s == 'en attente' or s == 'en_attente' or s == 'dossier_en_attente' %} bg-warning text-dark
                           {% else %} bg-secondary {% endif %}">
                          {{ s }}
                        </span>
                      </td>
                 </tr>
                  {% endfor %}
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

       <div class="card shadow-sm mt-3">
        <div class="card-header"><strong>R√©servations (12 derniers mois)</strong></div>
        <div class="card-body">
          <canvas id="reservationsChart" width="400" height="150"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card shadow-sm">
        <div class="card-header">
          <strong>Actions rapides</strong>
        </div>
         <div class="card-body">
          <p class="mb-3 text-muted">Cr√©er rapidement un √©l√©ment ou lancer une action.</p>

          <div class="d-grid gap-2">
            {# MODIFI√â : Utilise ea_url() #}
            <a href="{{ ea_url().setController('App\\Controller\\Admin\\UserCrudController').setAction('new') }}" class="btn btn-outline-primary">‚ûï Cr√©er un utilisateur</a>
            <a href="{{ ea_url().setController('App\\Controller\\Admin\\SalleCrudController').setAction('new') }}" class="btn btn-outline-primary">‚ûï Cr√©er une salle</a>

            {# Ce lien n'est pas g√©r√© par EasyAdmin, on le laisse #}
            <a href="{{ path('app_notifications') }}" class="btn btn-outline-success">üîî Notifications</a>
          </div>
        </div>
       </div>

      <div class="card shadow-sm mt-3">
        <div class="card-header"><strong>Infos</strong></div>
        <div class="card-body">
          <p class="small text-muted mb-0">Rappel : consulter les r√®gles de r√©servation et le dossier technique pour l'Espace 1500.</p>
        </div>
      </div>
    </div>
  </div>

</div>

{# Chart.js via CDN (si ton environnement n'a pas d'acc√®s externe, charge la lib en local) #}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  (function() {
    const labels = {{ chartLabels|default([])|json_encode|raw }};
    const data = {{ chartData|default([])|json_encode|raw }};

    const ctx = document.getElementById('reservationsChart');
    if (!ctx) return;
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'R√©servations',
          data: data,
          borderRadius: 6,
          barThickness: 28,
          backgroundColor: 'rgba(54, 162, 235, 0.85)'
         }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { mode: 'index', intersect: false }
        },
        scales: {
          x: { grid: { display: false } },
           y: { beginAtZero: true, ticks: { precision:0 } }
        }
      }
    });
  })();
</script>
{% endblock %}