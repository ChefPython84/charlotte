{% extends 'base.html.twig' %}

{% block title %}{{ salle.nom }}{% endblock %}

{% block body %}
    <div class="container-fluid py-5">
        <div class="row">
            <div class="col-lg-7">
                {# Carrousel (simplifié) #}
                {% set mainPhoto = salle.photos|filter(p => p.isPrincipale)|first %}
                {% if mainPhoto %}
                    <img src="{{ asset(mainPhoto.url) }}" class="img-fluid rounded mb-3" alt="{{ salle.nom }}">
                {% else %}
                     <img src="https://via.placeholder.com/800x500" class="img-fluid rounded mb-3" alt="Placeholder">
                {% endif %}

                {# Autres photos... #}
                
                <hr class="my-4">

                <h2>Description</h2>
                <p>{{ salle.description|nl2br }}</p>
            </div>

            <div class="col-lg-5">
                <div class="sticky-top" style="top: 20px;">
                    <div class="card shadow-sm border-0">
                        <div class="card-body p-4">
                            <h1 class="h3">{{ salle.nom }}</h1>
                            <p class="text-muted">{{ salle.ville }}</p>
                            
                            <div class="d-flex justify-content-between mb-3">
                                <span class="badge bg-light text-dark fs-6 p-2">Capacité: {{ salle.capacite }} pers.</span>
                                <span class="badge bg-success text-white fs-6 p-2">Dès {{ salle.prixHeure }}€/h</span>
                            </div>

                            <h5>Équipements inclus</h5>
                            <ul class="list-unstyled">
                                {% for equip in salle.equipements %}
                                    <li><i class="bi bi-check-circle-fill text-success"></i> {{ equip.nom }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <div class="card shadow-sm border-0 mt-3">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">Réserver cette salle</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Cliquez sur un créneau "Disponible" dans le calendrier pour faire une demande.</p>
                            
                            <div id="calendar" style="min-height: 400px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# ... Autres sections (avis, etc.) ... #}
{% endblock %}

{% block javascripts %}
    {{ parent() }} {# OBLIGATOIRE : charge les scripts de base.html.twig #}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            const salleId = {{ salle.id }};
            
            // Référence à la modale Bootstrap
            const bookingModalEl = document.getElementById('bookingModal');
            const modal = new bootstrap.Modal(bookingModalEl);
            const modalContentEl = document.getElementById('bookingModalContent');

            const calendar = new FullCalendar.Calendar(calendarEl, {
                
                {# MODIFICATION : Ligne supprimée car incluse dans le bundle global #}
                {# plugins: ['dayGrid', 'timeGrid', 'interaction'], #}
                
                initialView: 'timeGridWeek',
                locale: 'fr',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                
                // 1. On charge les créneaux 'libres' (via la route modifiée)
                events: `/salle/${salleId}/reservations`,
                
                // 2. On désactive la sélection libre
                selectable: false,
                
                // 3. On AJOUTE 'eventClick' : se déclenche au clic sur un créneau
                eventClick: function(info) {
                    
                    // On ne fait rien si ce n'est pas un de nos événements
                    if (!info.event.id) return;
                    
                    const dispoId = info.event.id;
                    
                    // Ouvre la modale et charge le formulaire
                    modalContentEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"></div></div>';
                    modal.show();

                    // Requête AJAX pour charger le formulaire (basé sur l'ID du créneau)
                    fetch(`/salle/${salleId}/reservation/new?dispo_id=${dispoId}`, {
                        headers: { 'X-Requested-With':'XMLHttpRequest' }
                    })
                    .then(r => r.text())
                    .then(html => {
                        modalContentEl.innerHTML = html;
                        
                        // Attache l'écouteur de soumission au formulaire chargé
                        const form = document.getElementById('reservation-form');
                        if (form) {
                            form.addEventListener('submit', function(e) {
                                e.preventDefault();
                                const fd = new FormData(form);
                                
                                // POST de la réservation
                                fetch(form.action, {
                                    method: 'POST',
                                    headers: { 'X-Requested-With':'XMLHttpRequest' },
                                    body: fd
                                })
                                .then(r => r.json())
                                .then(json => {
                                    if(json.success) {
                                        modal.hide();
                                        calendar.refetchEvents(); // Recharge les créneaux
                                        alert(json.message || 'Réservation enregistrée');
                                    } else {
                                        alert(json.message || 'Erreur lors de la réservation.');
                                    }
                                })
                                .catch(err => {
                                    alert('Erreur technique.');
                                });
                            });
                        }
                    })
                    .catch(err => {
                         modalContentEl.innerHTML = '<div class="alert alert-danger">Erreur de chargement.</div>';
                    });
                }
            });

            calendar.render();
        });
    </script>
{% endblock %}